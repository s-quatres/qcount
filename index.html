<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>8-Count Beat Counter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 20px;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .beat-indicator {
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 4px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: bold;
            transition: transform 0.08s ease, background 0.08s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .beat-indicator.pulse {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .beat-indicator.accent {
            background: rgba(255, 215, 0, 0.4);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .beat-indicator.waiting {
            border-color: rgba(255, 204, 0, 0.6);
        }

        /* Beat dots */
        .phrase-display {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 20px;
        }

        .beat-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            transition: all 0.1s ease;
        }

        .beat-dot.current {
            background: rgba(255, 255, 255, 0.6);
            transform: scale(1.2);
        }

        .beat-dot.accent-beat {
            border: 2px solid rgba(255, 215, 0, 0.8);
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 6px;
            opacity: 0.9;
        }

        .slider-value {
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* Volume meter */
        .volume-container {
            margin-bottom: 15px;
        }

        .volume-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .volume-meter {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .volume-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4cd964, #ffcc00, #ff3b30);
            border-radius: 3px;
            transition: width 0.05s ease;
        }

        .band-btn {
            flex: 1;
            padding: 8px 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .band-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
        }

        .band-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .freq-band {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 6px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .freq-band.selected {
            border-color: #4cd964;
            background: rgba(76, 217, 100, 0.2);
        }

        .freq-band:hover {
            background: rgba(255,255,255,0.2);
        }

        .band-beat {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            margin: 0 auto 4px;
            transition: all 0.05s;
        }

        .band-beat.flash {
            background: #ffcc00;
            box-shadow: 0 0 10px #ffcc00;
        }

        .band-bar {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .band-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4cd964, #ffcc00);
            transition: width 0.05s;
        }

        .band-label {
            font-size: 0.6rem;
            opacity: 0.8;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-stopped { background: rgba(255, 255, 255, 0.2); }
        .status-waiting { background: rgba(255, 204, 0, 0.3); border: 1px solid rgba(255, 204, 0, 0.6); }
        .status-learning { background: rgba(100, 149, 237, 0.3); border: 1px solid rgba(100, 149, 237, 0.6); }
        .status-counting { background: rgba(76, 217, 100, 0.3); border: 1px solid rgba(76, 217, 100, 0.6); }

        .control-button {
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .control-button:active {
            transform: scale(0.98);
        }

        .control-button.listening {
            background: #ff3b30;
            color: white;
        }

        .instructions {
            text-align: center;
            margin-top: 15px;
            font-size: 0.75rem;
            opacity: 0.7;
            line-height: 1.4;
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            .beat-indicator { width: 140px; height: 140px; font-size: 3rem; }
            .beat-dot { width: 25px; height: 25px; font-size: 0.6rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>8-Count</h1>
        <p class="subtitle">Predictive counting with tempo lock</p>

        <div class="beat-indicator" id="beatIndicator">
            <span id="currentCount">-</span>
        </div>

        <div class="phrase-display" id="phraseDisplay">
            <div class="beat-dot accent-beat" data-beat="1">1</div>
            <div class="beat-dot" data-beat="2">2</div>
            <div class="beat-dot" data-beat="3">3</div>
            <div class="beat-dot" data-beat="4">4</div>
            <div class="beat-dot" data-beat="5">5</div>
            <div class="beat-dot" data-beat="6">6</div>
            <div class="beat-dot" data-beat="7">7</div>
            <div class="beat-dot" data-beat="8">8</div>
        </div>

        <div id="controlsContainer" style="display: none;">
            <!-- Volume meter -->
            <div class="volume-container">
                <div class="volume-label">
                    <span>Volume</span>
                    <span id="volumePercent">0%</span>
                </div>
                <div class="volume-meter">
                    <div class="volume-bar" id="volumeBar"></div>
                </div>
            </div>

            <!-- 10 Frequency band grid with beat indicators -->
            <div class="slider-label" style="margin-bottom: 8px;">
                <span>Frequency Bands (tap to select)</span>
                <span class="slider-value" id="selectedBandLabel">All</span>
            </div>
            <div id="bandGrid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 15px;">
                <div class="freq-band selected" data-band="0">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">20-50</div>
                </div>
                <div class="freq-band" data-band="1">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">50-100</div>
                </div>
                <div class="freq-band" data-band="2">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">100-200</div>
                </div>
                <div class="freq-band" data-band="3">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">200-400</div>
                </div>
                <div class="freq-band" data-band="4">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">400-800</div>
                </div>
                <div class="freq-band" data-band="5">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">0.8-1.6k</div>
                </div>
                <div class="freq-band" data-band="6">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">1.6-3.2k</div>
                </div>
                <div class="freq-band" data-band="7">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">3.2-6.4k</div>
                </div>
                <div class="freq-band" data-band="8">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">6.4-12k</div>
                </div>
                <div class="freq-band" data-band="9">
                    <div class="band-beat"></div>
                    <div class="band-bar"><div class="band-fill"></div></div>
                    <div class="band-label">12-20k</div>
                </div>
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="band-btn active" data-band="all" id="allBandBtn">Use All</button>
            </div>

            <!-- Sensitivity slider -->
            <div class="slider-container">
                <div class="slider-label">
                    <span>Beat Sensitivity</span>
                    <span class="slider-value" id="sensitivityValue">1.3</span>
                </div>
                <input type="range" min="1.0" max="2.0" step="0.1" value="1.3" id="sensitivitySlider">
            </div>

            <!-- Beats for prediction slider -->
            <div class="slider-container">
                <div class="slider-label">
                    <span>Beats to lock tempo</span>
                    <span class="slider-value" id="lockBeatsValue">4</span>
                </div>
                <input type="range" min="2" max="8" step="1" value="4" id="lockBeatsSlider">
            </div>

            <!-- Tolerance slider -->
            <div class="slider-container">
                <div class="slider-label">
                    <span>Beat Tolerance</span>
                    <span class="slider-value" id="toleranceValue">25%</span>
                </div>
                <input type="range" min="10" max="50" step="5" value="25" id="toleranceSlider">
            </div>

            <!-- Volume threshold slider -->
            <div class="slider-container">
                <div class="slider-label">
                    <span>Min Volume</span>
                    <span class="slider-value" id="volumeThresholdValue">5%</span>
                </div>
                <input type="range" min="1" max="20" step="1" value="5" id="volumeThresholdSlider">
            </div>
        </div>

        <div class="info-panel">
            <div class="info-row">
                <span class="info-label">Status</span>
                <span class="status-badge status-stopped" id="statusBadge">Stopped</span>
            </div>
            <div class="info-row">
                <span class="info-label">BPM</span>
                <span class="info-value" id="bpmValue">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Mode</span>
                <span class="info-value" id="modeInfo">--</span>
            </div>
        </div>

        <button class="control-button" id="controlButton">Start Listening</button>

        <p class="instructions">
            Learns tempo from first beats, then counts predictively.
            Only adjusts if timing changes consistently.
        </p>

        <!-- Debug panel -->
        <div class="info-panel" id="debugPanel" style="display: none; margin-top: 15px; font-size: 0.7rem;">
            <div style="font-weight: bold; margin-bottom: 8px;">Debug Info</div>
            <div id="debugLog" style="max-height: 150px; overflow-y: auto; font-family: monospace; line-height: 1.4;"></div>
        </div>

        <button id="toggleDebug" style="margin-top: 10px; padding: 8px 12px; font-size: 0.75rem; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; cursor: pointer;">
            Show Debug
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/meyda@5.6.0/dist/web/meyda.min.js"></script>
    <script>
        class BeatCounter {
            constructor() {
                this.isListening = false;
                this.audioContext = null;
                this.microphone = null;
                this.meydaAnalyzer = null;

                // Settings
                this.sensitivity = 1.3; // Lower = more sensitive to beats
                this.lockBeats = 4; // How many consistent beats needed to lock/adjust tempo
                this.tolerance = 0.25; // Beat timing tolerance (25%)
                this.volumeThreshold = 0.05; // Min volume to detect beats (5%)

                // Volume
                this.volumeHistory = [];
                this.smoothedVolume = 0;
                this.maxObservedVolume = 0.02; // Lower starting max for better sensitivity

                // Beat detection
                this.energyHistory = [];
                this.lastBeatTime = 0;
                this.selectedBand = 0; // 0-9 for specific band, 'all' for combined
                this.analyser = null;
                this.frequencyData = null;

                // 10 frequency bands with individual beat detection
                this.bandRanges = [
                    [20, 50], [50, 100], [100, 200], [200, 400], [400, 800],
                    [800, 1600], [1600, 3200], [3200, 6400], [6400, 12800], [12800, 20000]
                ];
                this.bandEnergies = new Array(10).fill(0);
                this.maxBandEnergies = new Array(10).fill(0.01);
                this.bandEnergyHistories = Array.from({length: 10}, () => []);
                this.bandLastBeatTime = new Array(10).fill(0);

                // Tempo tracking
                this.beatTimes = []; // Actual detected beat times
                this.beatIntervals = []; // Intervals between beats
                this.beatEnergies = []; // Energy of each beat for accent detection
                this.lockedBPM = 0; // Locked tempo
                this.lockedInterval = 0; // Interval in seconds

                // Predictive counting
                this.isTempoLocked = false;
                this.countTimer = null;
                this.currentCount = 0; // 0-7
                this.nextScheduledTime = 0;

                // Accent tracking for phrase realignment
                this.accentHistory = []; // Track where accents fall relative to current count
                this.requiredAccents = 3; // Need 3 consistent accents to realign

                // Phrase tracking
                this.phraseStartTime = 0;

                // Voice
                this.synth = window.speechSynthesis;
                this.selectedVoice = null;

                // UI
                this.controlButton = document.getElementById('controlButton');
                this.statusBadge = document.getElementById('statusBadge');
                this.beatIndicator = document.getElementById('beatIndicator');
                this.currentCountEl = document.getElementById('currentCount');
                this.bpmValue = document.getElementById('bpmValue');
                this.modeInfo = document.getElementById('modeInfo');
                this.volumeBar = document.getElementById('volumeBar');
                this.volumePercent = document.getElementById('volumePercent');
                this.controlsContainer = document.getElementById('controlsContainer');
                this.sensitivitySlider = document.getElementById('sensitivitySlider');
                this.sensitivityValue = document.getElementById('sensitivityValue');
                this.lockBeatsSlider = document.getElementById('lockBeatsSlider');
                this.lockBeatsValue = document.getElementById('lockBeatsValue');
                this.toleranceSlider = document.getElementById('toleranceSlider');
                this.toleranceValue = document.getElementById('toleranceValue');
                this.volumeThresholdSlider = document.getElementById('volumeThresholdSlider');
                this.volumeThresholdValue = document.getElementById('volumeThresholdValue');
                this.beatDots = document.querySelectorAll('.beat-dot');
                this.debugPanel = document.getElementById('debugPanel');
                this.debugLog = document.getElementById('debugLog');
                this.toggleDebugBtn = document.getElementById('toggleDebug');
                this.debugEnabled = false;

                // Frequency band UI
                this.freqBands = document.querySelectorAll('.freq-band');
                this.selectedBandLabel = document.getElementById('selectedBandLabel');
                this.allBandBtn = document.getElementById('allBandBtn');

                this.bindEvents();
            }

            bindEvents() {
                this.controlButton.addEventListener('click', () => {
                    if (this.isListening) {
                        this.stop();
                    } else {
                        this.start();
                    }
                });

                this.sensitivitySlider.addEventListener('input', (e) => {
                    this.sensitivity = parseFloat(e.target.value);
                    this.sensitivityValue.textContent = this.sensitivity.toFixed(1);
                });

                this.lockBeatsSlider.addEventListener('input', (e) => {
                    this.lockBeats = parseInt(e.target.value);
                    this.lockBeatsValue.textContent = this.lockBeats;
                });

                this.toleranceSlider.addEventListener('input', (e) => {
                    this.tolerance = parseInt(e.target.value) / 100;
                    this.toleranceValue.textContent = e.target.value + '%';
                });

                this.volumeThresholdSlider.addEventListener('input', (e) => {
                    this.volumeThreshold = parseInt(e.target.value) / 100;
                    this.volumeThresholdValue.textContent = e.target.value + '%';
                });

                // Select best voice when voices are loaded
                this.selectBestVoice();
                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => this.selectBestVoice();
                }

                // Debug toggle
                this.toggleDebugBtn.addEventListener('click', () => {
                    this.debugEnabled = !this.debugEnabled;
                    this.debugPanel.style.display = this.debugEnabled ? 'block' : 'none';
                    this.toggleDebugBtn.textContent = this.debugEnabled ? 'Hide Debug' : 'Show Debug';
                });

                // Band selection - click on individual bands
                this.freqBands.forEach(band => {
                    band.addEventListener('click', () => {
                        this.freqBands.forEach(b => b.classList.remove('selected'));
                        band.classList.add('selected');
                        this.allBandBtn.classList.remove('active');
                        this.selectedBand = parseInt(band.dataset.band);
                        const range = this.bandRanges[this.selectedBand];
                        this.selectedBandLabel.textContent = `${range[0]}-${range[1]}Hz`;
                        this.log(`Switched to band ${this.selectedBand}: ${range[0]}-${range[1]}Hz`);
                        this.energyHistory = [];
                    });
                });

                // "Use All" button
                this.allBandBtn.addEventListener('click', () => {
                    this.freqBands.forEach(b => b.classList.remove('selected'));
                    this.allBandBtn.classList.add('active');
                    this.selectedBand = 'all';
                    this.selectedBandLabel.textContent = 'All';
                    this.log('Switched to all bands');
                    this.energyHistory = [];
                });
            }

            log(msg) {
                if (!this.debugEnabled) return;
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                const line = document.createElement('div');
                line.textContent = `${time} ${msg}`;
                this.debugLog.appendChild(line);
                this.debugLog.scrollTop = this.debugLog.scrollHeight;
                // Keep last 50 lines
                while (this.debugLog.children.length > 50) {
                    this.debugLog.removeChild(this.debugLog.firstChild);
                }
            }

            async start() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
                    });

                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.microphone = this.audioContext.createMediaStreamSource(stream);

                    // Create analyser for frequency bands
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 1024;
                    this.microphone.connect(this.analyser);
                    this.frequencyData = new Uint8Array(this.analyser.frequencyBinCount);

                    this.meydaAnalyzer = Meyda.createMeydaAnalyzer({
                        audioContext: this.audioContext,
                        source: this.microphone,
                        bufferSize: 512,
                        featureExtractors: ['rms', 'energy'],
                        callback: (features) => this.processAudio(features)
                    });

                    this.meydaAnalyzer.start();
                    this.resetState();

                    this.isListening = true;
                    this.controlsContainer.style.display = 'block';
                    this.updateUI();
                    this.updateStatus('Learning tempo...', 'learning');
                    this.modeInfo.textContent = 'Listening';
                    this.beatIndicator.classList.add('waiting');

                } catch (error) {
                    console.error('Error:', error);
                    alert('Please allow microphone access.');
                }
            }

            stop() {
                if (this.countTimer) {
                    clearTimeout(this.countTimer);
                    this.countTimer = null;
                }
                if (this.meydaAnalyzer) this.meydaAnalyzer.stop();
                if (this.microphone && this.microphone.mediaStream) {
                    this.microphone.mediaStream.getTracks().forEach(t => t.stop());
                }
                if (this.audioContext) this.audioContext.close();

                this.isListening = false;
                this.controlsContainer.style.display = 'none';
                this.updateUI();
                this.updateStatus('Stopped', 'stopped');
                this.currentCountEl.textContent = '-';
                this.bpmValue.textContent = '--';
                this.modeInfo.textContent = '--';
                this.beatIndicator.classList.remove('waiting', 'accent', 'pulse');
                this.clearDots();
            }

            resetState() {
                this.volumeHistory = [];
                this.smoothedVolume = 0;
                this.maxObservedVolume = 0.05;
                this.energyHistory = [];
                this.lastBeatTime = 0;
                this.beatTimes = [];
                this.beatIntervals = [];
                this.beatEnergies = [];
                this.lockedBPM = 0;
                this.lockedInterval = 0;
                this.isTempoLocked = false;
                this.currentCount = 0;
                this.nextScheduledTime = 0;
                this.phraseStartTime = 0;
                this.accentHistory = [];
                this.maxBandEnergies = new Array(10).fill(0.01);
                this.bandEnergyHistories = Array.from({length: 10}, () => []);
                this.bandLastBeatTime = new Array(10).fill(0);
                if (this.countTimer) {
                    clearTimeout(this.countTimer);
                    this.countTimer = null;
                }
            }

            processAudio(features) {
                if (!features || !this.isListening) return;

                const now = this.audioContext.currentTime;
                const rms = features.rms || 0;

                // Get frequency data for band analysis
                this.analyser.getByteFrequencyData(this.frequencyData);
                this.calculateBandEnergies();
                this.detectBandBeats(now);
                this.updateBandDisplay();

                // Smooth volume
                this.volumeHistory.push(rms);
                if (this.volumeHistory.length > 10) this.volumeHistory.shift();
                this.smoothedVolume = this.volumeHistory.reduce((a, b) => a + b, 0) / this.volumeHistory.length;

                if (this.smoothedVolume > this.maxObservedVolume) {
                    this.maxObservedVolume = this.smoothedVolume;
                }

                this.updateVolumeDisplay();

                // Check volume threshold
                const volumePercent = this.smoothedVolume / Math.max(this.maxObservedVolume, 0.01);
                if (volumePercent < this.volumeThreshold) {
                    return;
                }

                // Select energy based on chosen band
                let energy;
                if (this.selectedBand === 'all') {
                    energy = rms;
                } else {
                    energy = this.bandEnergies[this.selectedBand];
                }

                // Beat detection for main counter
                this.energyHistory.push(energy);
                if (this.energyHistory.length > 25) this.energyHistory.shift();
                if (this.energyHistory.length < 4) return;

                const avgEnergy = this.energyHistory.reduce((a, b) => a + b, 0) / this.energyHistory.length;
                const threshold = avgEnergy * this.sensitivity;
                const timeSinceLast = now - this.lastBeatTime;

                if (energy > threshold && timeSinceLast > 0.15) {
                    this.log(`BEAT! band=${this.selectedBand} energy=${energy.toFixed(3)} thresh=${threshold.toFixed(3)}`);
                    this.onBeatDetected(now, energy);
                }
            }

            calculateBandEnergies() {
                const sampleRate = this.audioContext.sampleRate;
                const binCount = this.analyser.frequencyBinCount;
                const binWidth = sampleRate / (binCount * 2);

                // Calculate energy for each of the 10 bands
                for (let b = 0; b < 10; b++) {
                    const [lowFreq, highFreq] = this.bandRanges[b];
                    const startBin = Math.floor(lowFreq / binWidth);
                    const endBin = Math.min(binCount - 1, Math.floor(highFreq / binWidth));

                    let sum = 0;
                    let count = 0;
                    for (let i = startBin; i <= endBin; i++) {
                        sum += this.frequencyData[i] / 255;
                        count++;
                    }

                    this.bandEnergies[b] = count > 0 ? sum / count : 0;

                    if (this.bandEnergies[b] > this.maxBandEnergies[b]) {
                        this.maxBandEnergies[b] = this.bandEnergies[b];
                    }
                }
            }

            detectBandBeats(now) {
                // Detect beats in each band independently and flash indicators
                for (let b = 0; b < 10; b++) {
                    const energy = this.bandEnergies[b];

                    // Track energy history per band
                    this.bandEnergyHistories[b].push(energy);
                    if (this.bandEnergyHistories[b].length > 15) {
                        this.bandEnergyHistories[b].shift();
                    }

                    if (this.bandEnergyHistories[b].length < 4) continue;

                    const avg = this.bandEnergyHistories[b].reduce((a, c) => a + c, 0) / this.bandEnergyHistories[b].length;
                    const threshold = avg * this.sensitivity;
                    const timeSinceLast = now - this.bandLastBeatTime[b];

                    // Detect beat in this band
                    if (energy > threshold && timeSinceLast > 0.12) {
                        this.bandLastBeatTime[b] = now;
                        // Flash the indicator
                        const bandEl = this.freqBands[b];
                        const beatIndicator = bandEl.querySelector('.band-beat');
                        beatIndicator.classList.add('flash');
                        setTimeout(() => beatIndicator.classList.remove('flash'), 100);
                    }
                }
            }

            updateBandDisplay() {
                // Update the energy bar for each band
                for (let b = 0; b < 10; b++) {
                    const percent = Math.min(100, (this.bandEnergies[b] / Math.max(this.maxBandEnergies[b], 0.01)) * 100);
                    const bandEl = this.freqBands[b];
                    const fill = bandEl.querySelector('.band-fill');
                    fill.style.width = percent + '%';
                }
            }

            onBeatDetected(time, energy) {
                // Record beat time and energy
                if (this.lastBeatTime > 0) {
                    const interval = time - this.lastBeatTime;
                    this.log(`Interval: ${interval.toFixed(3)}s (${Math.round(60/interval)} BPM)`);
                    if (interval > 0.2 && interval < 1.5) { // 40-300 BPM range
                        this.beatIntervals.push(interval);
                        this.beatTimes.push(time);
                        this.beatEnergies.push(energy);
                        this.log(`Stored. Total intervals: ${this.beatIntervals.length}`);

                        // Keep rolling window
                        if (this.beatIntervals.length > 16) {
                            this.beatIntervals.shift();
                            this.beatTimes.shift();
                            this.beatEnergies.shift();
                        }

                        this.checkTempo();

                        // Check for accent (potential "1" beat) if locked
                        if (this.isTempoLocked) {
                            this.checkForAccent(energy);
                        }
                    }
                }
                this.lastBeatTime = time;
            }

            checkTempo() {
                if (this.beatIntervals.length < this.lockBeats) {
                    this.modeInfo.textContent = `${this.beatIntervals.length}/${this.lockBeats} beats`;
                    this.log(`Need more beats: ${this.beatIntervals.length}/${this.lockBeats}`);
                    return;
                }

                // Get last N intervals
                const recentIntervals = this.beatIntervals.slice(-this.lockBeats);

                // Calculate median of recent intervals
                const sorted = [...recentIntervals].sort((a, b) => a - b);
                const median = sorted[Math.floor(sorted.length / 2)];

                // Check consistency - count how many are within tolerance
                const consistentCount = recentIntervals.filter(i =>
                    Math.abs(i - median) / median < this.tolerance
                ).length;

                // Need at least 60% of beats to be consistent
                const minConsistent = Math.ceil(recentIntervals.length * 0.6);
                const isConsistent = consistentCount >= minConsistent;

                this.log(`Intervals: [${recentIntervals.map(i => i.toFixed(2)).join(', ')}]`);
                this.log(`Median: ${median.toFixed(3)}s Consistent: ${consistentCount}/${recentIntervals.length} Need: ${minConsistent}`);

                // Show progress
                if (!this.isTempoLocked) {
                    this.modeInfo.textContent = `${consistentCount}/${recentIntervals.length} consistent`;
                }

                if (!isConsistent) {
                    this.log(`NOT consistent enough`);
                    // Beats are inconsistent - but if locked, keep counting!
                    // Just try to adjust tempo gradually
                    if (this.isTempoLocked) {
                        const avgRecent = recentIntervals.reduce((a, b) => a + b, 0) / recentIntervals.length;
                        // Gradually adjust tempo even when inconsistent
                        this.lockedInterval = this.lockedInterval * 0.9 + avgRecent * 0.1;
                        this.lockedBPM = 60 / this.lockedInterval;
                        this.bpmValue.textContent = Math.round(this.lockedBPM);
                        this.modeInfo.textContent = 'Adjusting';
                    }
                    return;
                }

                // Intervals are consistent
                const newBPM = 60 / median;

                if (!this.isTempoLocked) {
                    // Lock tempo and start predictive counting
                    this.lockedBPM = newBPM;
                    this.lockedInterval = median;
                    this.isTempoLocked = true;
                    this.currentCount = 0;
                    this.phraseStartTime = this.beatTimes[this.beatTimes.length - 1];

                    this.log(`*** LOCKED! BPM=${Math.round(this.lockedBPM)} interval=${median.toFixed(3)}s ***`);

                    this.updateStatus('Counting', 'counting');
                    this.modeInfo.textContent = 'Locked';
                    this.bpmValue.textContent = Math.round(this.lockedBPM);
                    this.beatIndicator.classList.remove('waiting');

                    // Start the count immediately, then schedule next
                    this.doCount();
                    this.scheduleNextCount();
                } else {
                    // Already locked - check if we should adjust
                    const drift = Math.abs(median - this.lockedInterval) / this.lockedInterval;

                    if (drift > 0.05) { // More than 5% change
                        // Smoothly adjust tempo
                        this.lockedInterval = this.lockedInterval * 0.7 + median * 0.3;
                        this.lockedBPM = 60 / this.lockedInterval;
                        this.bpmValue.textContent = Math.round(this.lockedBPM);

                        // Reschedule if needed
                        this.rescheduleCount();
                    }
                }
            }

            checkForAccent(energy) {
                // Check if this beat is significantly louder than recent beats
                if (this.beatEnergies.length < 8) return;

                const recentEnergies = this.beatEnergies.slice(-8);
                const avgEnergy = recentEnergies.reduce((a, b) => a + b, 0) / recentEnergies.length;

                // If this beat is 50% louder than average, record it as an accent
                if (energy > avgEnergy * 1.5) {
                    const currentPos = this.currentCount; // 0-7

                    // Record where this accent fell
                    this.accentHistory.push(currentPos);

                    // Keep only last 8 accents
                    if (this.accentHistory.length > 8) {
                        this.accentHistory.shift();
                    }

                    // Check if we have enough consistent accents to realign
                    if (this.accentHistory.length >= this.requiredAccents) {
                        // Count which position has the most accents
                        const counts = {};
                        for (const pos of this.accentHistory) {
                            counts[pos] = (counts[pos] || 0) + 1;
                        }

                        // Find position with most accents
                        let maxPos = 0;
                        let maxCount = 0;
                        for (const [pos, count] of Object.entries(counts)) {
                            if (count > maxCount) {
                                maxCount = count;
                                maxPos = parseInt(pos);
                            }
                        }

                        // Only realign if:
                        // 1. At least 3 accents on same position
                        // 2. That position is NOT beat 0 (already aligned)
                        // 3. That position accounts for majority of recent accents
                        if (maxCount >= 3 && maxPos !== 0 && maxCount >= this.accentHistory.length * 0.6) {
                            // Set current count so next beat will be "1"
                            // If accents keep falling on position 3, we want to shift so that becomes 0
                            this.currentCount = 7; // Next increment will make it 0 (which displays as 1)
                            this.accentHistory = []; // Reset after realignment
                            this.modeInfo.textContent = 'Realigned';
                        }
                    }
                }
            }

            scheduleNextCount() {
                if (!this.isTempoLocked || !this.isListening) return;

                // Simply schedule next count after one beat interval
                const delayMs = this.lockedInterval * 1000;

                this.countTimer = setTimeout(() => {
                    if (this.isListening && this.isTempoLocked) {
                        // Always increment sequentially: 0,1,2,3,4,5,6,7,0,1,2...
                        this.currentCount = (this.currentCount + 1) % 8;
                        this.doCount();
                        this.scheduleNextCount();
                    }
                }, delayMs);
            }

            rescheduleCount() {
                // Don't interrupt current timing - just let next count use new interval
                // The scheduleNextCount will pick up the new lockedInterval
            }

            doCount() {
                const displayCount = this.currentCount + 1; // 1-8

                // Visual
                this.currentCountEl.textContent = displayCount;
                this.beatIndicator.classList.remove('accent');
                if (displayCount === 1) {
                    this.beatIndicator.classList.add('accent');
                }

                this.beatIndicator.classList.add('pulse');
                setTimeout(() => {
                    this.beatIndicator.classList.remove('pulse');
                }, 80);

                this.updateDots(this.currentCount);

                // Speak
                this.speakCount(displayCount);
            }

            updateDots(currentIndex) {
                this.beatDots.forEach((dot, i) => {
                    dot.classList.remove('current');
                    if (i === currentIndex) {
                        dot.classList.add('current');
                    }
                });
            }

            clearDots() {
                this.beatDots.forEach(dot => dot.classList.remove('current'));
            }

            speakCount(count) {
                if (this.synth.speaking) {
                    this.synth.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(count.toString());

                // Use selected voice if available
                if (this.selectedVoice) {
                    utterance.voice = this.selectedVoice;
                }

                // Softer, more natural settings
                utterance.rate = 1.4; // Slower, more relaxed
                utterance.volume = 0.5; // Softer
                utterance.pitch = count === 1 ? 1.1 : 0.95; // Subtle accent on 1

                this.synth.speak(utterance);
            }

            selectBestVoice() {
                const voices = this.synth.getVoices();
                if (voices.length === 0) return;

                // Prefer natural/enhanced voices
                const preferred = [
                    'Samantha', // iOS/Mac - very natural
                    'Karen',    // Australian - soft
                    'Moira',    // Irish - gentle
                    'Tessa',    // South African
                    'Fiona',    // Scottish
                    'Daniel',   // British - calm
                    'Google',   // Google voices are decent
                ];

                for (const name of preferred) {
                    const voice = voices.find(v => v.name.includes(name));
                    if (voice) {
                        this.selectedVoice = voice;
                        return;
                    }
                }

                // Fallback to first English voice
                const englishVoice = voices.find(v => v.lang.startsWith('en'));
                if (englishVoice) {
                    this.selectedVoice = englishVoice;
                }
            }

            updateVolumeDisplay() {
                const scaled = this.smoothedVolume / Math.max(this.maxObservedVolume, 0.01);
                const percent = Math.min(100, scaled * 100);
                this.volumeBar.style.width = percent + '%';
                this.volumePercent.textContent = Math.round(percent) + '%';
            }

            updateUI() {
                if (this.isListening) {
                    this.controlButton.textContent = 'Stop';
                    this.controlButton.classList.add('listening');
                } else {
                    this.controlButton.textContent = 'Start Listening';
                    this.controlButton.classList.remove('listening');
                }
            }

            updateStatus(text, type) {
                this.statusBadge.textContent = text;
                this.statusBadge.className = 'status-badge status-' + type;
            }
        }

        window.addEventListener('load', () => {
            new BeatCounter();
        });
    </script>
</body>
</html>
